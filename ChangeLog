21 Apr 2006: Wouter
	- put NSEC3 code in nsec3.c and nsec3.h.
	- iterated_hash only adds the salt if salt_len > 0.
	- added some assertions and cleanups to nsec3 code.
	- prehash also calcs the nsec3_last domain*.
	- dbaccess when reading in will set the rr_type.owner value.

20 Apr 2006: Wouter
	- Unittest of base 32 encoding. 
	- unittest start for iterated hash.
	- fixed for ctrlc in debug mode.
	- delete zparser_conv_long, not used, not needed
	- nsd-xfer will display NSEC3 correctly. zonec parses.
	- improved usage() line from zonec, about -c none, must be -C.
	- base32 printed in lowercase (canonical format for DNS).
	- NSEC3 added prehash pointers to the namedb.
	- NSEC3 autodetects presence of NSEC3 in zone and parameters.

19 Apr 2006: Wouter
	- port fix base10 in zonec conv short from 2_2 branch to trunk.
	  and conv byte, algo, certificate, long.
	- configure option to enable NSEC3 (--enable-nsec3) support.
	- from Ben Laurie's NSEC3 patch, loaned the parse code,
	  base32 conversion code and iterated_hash. 
	  With some small modifications. The type rrdescriptors are 
	  indexed by value below SPF, and in 
	  rdata_wireformat_to_rdata_atoms BINARYWITHLENGTH checks
	  for end of buffer. Also parser checks for '-' salt.
	  Some layout (spaces after ,s). And NSEC3 define is used.
	  strtol used for iterations is base 10.
	- moved rrtype descriptor table sanity check to unittest.

18 Apr 2006: Wouter
	- Fixed check for SOA IN, bad ntohs in the check.
	- minimum timeout also enforced for very low expire times.
	- report the actual used length of the sockaddr to sento
	  for FreeBSD.

7 Apr 2006: Wouter
	- modified the kill_nsd tpkg so that it waits up to 10x5 secs
	  for nsd to make the pid file, and it wait up to 10x5 secs for
	  nsd to exit after the kill signal is given.
	- xfrd checks on startup if there is trailing garbage in the
	  diff file, left there by a previous xfrd killed in action.
	  It then snips off any partial parts, so service can resume.
	  Also the difffile_skip pos is set before any partial record there.
	- first version of nsd-patch; reads db and ixfrs and updates zones.
	- moved print_rdata from nsd-xfer to rdata.h to share code.
	- moved print_rr from nsd-xfer to util.h to share code.

6 Apr 2006: Wouter
	- notify handler passes acl number that matches to xfrd.
	- xfrd keeps a next_master for a zone, and sets it after notify.
	  when notified nsd will try to contact the master that sent
	  the notify, if send from an address that is both in acl
	  allow-notify and request-xfr.
	- xfrd closes its tcp and udp sockets on exit.
	- default names for diff file and xfrd state nicer.
	- fixed up kill nsd grep on ps.
	- fixed up race conditions in test script for kill nsd
	  wait for pid file creation by nsd, and grep -v grep in check.
	- in nsd signal-flags inherited from the parent are zeroed 
	  when a server_child starts. Also the server_child switches back
	  to NSD_RUN mode when a bad mode happens.
	- check if ixfrs start from the version in memory.
	- if IXFR/AXFR ends in a serial that is newer than the serial
	  that was sent in an notify, update the notified serial.

5 Apr 2006: Wouter
	- added lowerbound for retry timeout.
	- added extra assertions to xfrd-tcp.c, saying that the waiting line
	  for tcp connections must be empty if the counter is below max.
	- setup so that the first master tried is the first in acl list.
	- diff file skips OPT and TSIG RRs if they are put into the answer
	  section.
	- if IXFR contains an RR to delete that does not exist, nothing
	  happens.
	- update zone for NS, RRSIG also if multiple RRs in the rrset.
	- difffile: create zone struct also if domain exists already.
	- difffile: destroy temp region on error.
	- difffile: in delete_RR, create temp region outside of the routine,
	  so no alloc region, destroy region for every deleted RR.
	- difffile: for IXFR: do not delete final SOA RR.
	- difffile: unknown parts in file is an error.
	- difffile: EOF on last packet is ignored w/o giving an error.

4 Apr 2006: Wouter
	- Addes EACCES to the netio dispatch error bailout.
	- Removed EACCESS (probably due to log_msg), error on close
	  xfrd pipe is small, main process closes its end, and hopes for 
	  the best).
	- review: return on error condition in xfrd_tcp_open fixed.
	- review: expired when time >= expire_time, so it will not wait
	  for the retry after expire until it will detect the expiredness.
	- removed duplicate lines from xfrd_handle_zone_timeout.
	- review: copy of uint32_t using memcpy to avoid unaligned memory
	  accesses.
	- review: fd=-1 removed from set_refresh_now; only does timer.
	- on a tcp timeout it will retry immediately (instead of waiting
	  another retry timeout). This means if you set refresh_now, it will
	  interrupt a tcp-timer for a fresh retry with the next master.
	- put null in buffer for xfrd read state.
	- log msg uses string that exists instead of overwritten buffer.
	- read entry sets refresh depending on current time,
	  and makes sure not to check soa contents if none provided.
	  added explanatory comments.
	- EACCES back in check.
	- server_main first checks for terminated children, then select().
	  So when select is interrupted, by kill or quitting children,
	  it will first see if it has to quit itself, before restarting
	  the children.
	- destroy tempregion xfrd read on error.
	- check for serial existance in xfrd_handle_incoming_soa.
	- handle_incoming_soa uses set_timer_refresh routine.
	  and can handle expire times < refresh times.
	- log msg for udp socket() error.
	- review: xfrd_parse_soa_info email parse uses correct buffer spot.
	- added a lowerbound to refresh interval (=1 second now).
	- upon receipt of a IXFR, if the serial is older than the notified
	  serial, the zone stays refreshing (but the ixfr is saved).

3 Apr 2006: Wouter
	- Added buffer length check to internal ipc.
	- split out packet_read_query_section from the process_query_section
	  routine (and moved to packet.c/h).
	- xfrd reads passed packet via ipc.
	- ported over fix to 2_2 on missing rr types by removing the 
	  duplicate RRtype array, and using rrtype_to_string.
	- xfrd handles notifies. immediately starts updating.
	- xfrd state file format fix.
	- removed libwrap stuff - superseded by acls.
	  use provide-xfr: statements for your zone in the config file.
	  updated README for this.
	- updated tpkg tests for axfr to use provide-xfr: 127.0.0.1 NOKEY
	- review: move var create to start of function (xfrd_init()).

31 Mar 2006: Wouter
	- zone type has a pointer to zone options.
	- nsd options has an rbtree to find zone options in.
	- nsd checks acl for incoming notifies and replies
	  error or confirmation.
	- nicer layout in options.c.
	- updated makefile dependencies.
	- fixed sz for SOA_INFO ipc, which was too small.
	- notify is sent to server_main, server_main sends it to xfrd.

30 Mar 2006: Wouter
	- include: documented in manual page.
	- MAXINCLUDES define in one place (config.h).
	- configure checks for strptime in include files.
	- use %d instead of %zd (sparc5 machine does not get zd).
	- use region_strdup in configlexer.
	- added a check for EINVAL in dispatch - will abort
	  on the error instead of busy hang.

29 Mar 2006: Wouter
	- \r for config lexer. (similar changes to zonelexer).
	- forward port of fix to 2_2 branch:
	  short int in var_arg is promoted to int, according to B. Laurie.
	  The same logic for %o, %d %x would hold for %u I think.
	- in XFRD, soa prim_ns and email domain names are kept in a max
	  size buffer.
	- split up dname_parse into parse from string to wireformat
	  and parse from wireformat to memoryformat, so both can be called.
	- split up dname_make_from_packet into reading the wireformat
	  from the packet and the dname_make, so both can be called.
	- xfrd reads all soa info from incoming xfr packets.
	- xfrd will ignore TC bit on tcp channels.
	- nsd sends xfrd all soa info, including ttl and dnames.
	- config file now has an include: filename directive.

28 Mar 2006: Miek
	- forward port fixes for zone compiler and \r. svn:1926-1927
	- add DO bit MASK and remove the !! construct

17 Mar 2006: Wouter
	- according to axfr-clarify, added comments that we check
	  more leniently on further responses on a TCP stream.

16 Mar 2006: Wouter
	- Fixed up SOA INFO Send routines. Send from server works.
	- niced up xfrd state file.
	- Fixed up so that after a reload it will continue in diff file
	  where it left off.
	- made send of SOA info use write_socket, in case of short writes.
	- redesigned xfrd_tcp_read to use the same code for ipc read.
	- no free()s before xfrd exit.
	- xfrd handles incoming SOA INFO ipc packets.
	- removed debug, updated zones get SOA INFO sent.

15 Mar 2006: Wouter
	- Fixed up domain table insert, it was being used in routines
	  that originate from nsd-xfer that do not set compression numbers
	  correctly.
	- memleak fix in diffile in case of error.
	- difffile processing works so that NSD can read an axfr saved
	  into the nsd.diff file. (xfrd already request and save it there).
	- split off xfrd tcp handling into xfrd-tcp.c.
	- cleaned up send_udp in xfrd, and read_state.
	- removed xfrd tcp_send_blocking.
	- xfrd sets state from ok to refresh to expired based on timeout.
	- xfrd sets reload timeout.
	- Added zone updated to keep track of zones that are changed
	  after a reload. These zones get their information notifified
	  to xfrd.
	- removed unused zprintrr declaration from zonec.h
	- nsd sends soa information to xfrd.

14 Mar 2006: Wouter
	- TODO updated
	- worked on reload ixfr. It will add/delete RRs and zones.
	- xfrd receive parse of xfr messages improved. writes commit.
	- server compressed_dname_offsets table is increased if reload
	  creates extra names.
	- difffile will create zone and apex if not there (i.e. the zone
	  is configured but no data file provided).
	- bit more verbose in error message for bad diff file.
	- Typo fix in sample config file.

13 Mar 2006: Wouter
	- configure sets fseek (fgetpos/fsetpos) to use 64 bit interface
	  with _FILE_OFFSET_BITS=64.
	- nsd will skip loading the .db if the DB checksum is the same.
	- Miek added trace test and nsd kill test.
	- Wouter worked on diff file c.

10 Mar 2006: Wouter
	- Cleanup of UDP/TCP code in XFRD.
	- xfrd now has tcp max connections and managing. tcp read/write.
	- response TC on UDP ixfr, starts TCP.
	- sends correct ixfr and axfr queries, a bind server answers.
	- made packet_skip_dname() public.
	- sets read/write event flags for tcp fd right.

9 Mar 2006: Wouter
	- Removed header from DIFF file format. CRC not that imporant there,
	  you have to check the packets anyway.
	- cutest rbtree removed unused clean_rbtree and always_fail routines.
	- xfrd timeout handler, more work. Checks expire.

8 Mar 2006: Wouter
	- xfrd sends UDP xfr request to master(s) with timeouts, and stores
	  returned data on disk.
	- updated dependencies and declaration of write_soa_buffer.

7 Mar 2006: Wouter
	- Fixed printfs for size_t warnings on Mac OsX.

6 Mar 2006: nsd-team
   * Wouter: xfrd read and write work. Statefile is "nsd.xfst".
   * Wouter: nsd-checkconf checks dname parse of zone name:.
   * Wouter: updated difffile in parser.y, production in server: clause.
   * Wouter: zonec now takes -C for 'no config file' option.
   * Wouter: updated configyyrename.h for bison 1.875d on sparc.
   * Miek: zonec -h and nsd -h exit with exit code = 0.
   * Miek & Wouter: updated tpkgs to work again.
   * Wouter: xfrd read handle soas, handle soa_incoming part.
   * Wouter: moved compare_serial() from nsd-xfer to util.h.

4 Mar 2006: Wouter
	- xfrd zone and soa memory structure definitions.
	- xfrd init zones.
	- xfrd read and write state file code.
	- option for difffile: and xfrdfile: config lines.

3 Mar 2006: Wouter
	- Removed double kill after reload. Only socket cmd send.
	- Added code to handle race condition where xfrd is restarted
	  during a succesfull reload. Afterwards, the new server_main
	  only has the old xfrd pid, new xfrd is an orphan.
	  Solution: when xfrd closes cmd channel (i.e. it quit)
	  unexpectedly, send sighup to all processes in the group.
	  This should quit the orphan & all children & reload the
	  server_main, which will fork the children and xfrd again.

2 Mar 2006: Wouter
	- Added nsd-checkconf.8 to makedist.sh replace list.
	- DIFF file format updated.
	- removed tsigkey->server value, it was read in, but unused.
	- new function to add config file keys to tsig.
	- nsd-checkconf checks parsing of keys. 
	- Updated sample key file with valid keys.
	- added first xfrd files. xfrd is started from server_main.
	  xfrd listens to server and server to xfrd. xfrd is restarted
	  if it dies unexpectedly. xfrd quits when server signals it.
	  xfrd survives nsd reloads.
	- nsd_options no longer global variable.

1 Mar 2006: Wouter
	- Nicer text in nsd.8.
	- nsd.c prettier code in option handling.
	- zonec.c code prettier in option handling, also chdir bug removed.
	  zonec uses the zone definitions in the config file.
	  updated zonec.8 and usage().
	- nsd also chdirs to the zonedir, otherwise nsd and zonec would
	  try to read the database: file from different directories.
	  .(it does the chdir before the chroot call.)
	- new calling syntax for zonec and nsd, because of new config file.
	- options added acl acceptance tests (no tsig yet).
	- added unit test for options.c - for acl tests.
	- zonec removed unused vars, nsd-checkconf print arguments.
	- nsd-checkconf.8 manual page.

28 Feb 2006: Wouter
	- checked in options.h and config parser code.
	- also nsd-checkconf that will test a config file 
	  .(and optionally show what was read).
	- default identity has a spelling error.
	- Small fix (typo in example) to config manual page.
	- Added ; to configparser.y to please bison 1.75 on bsd.
	- Will check for blocked addresses in outgoing acls. Also ranges.
	- Check configuration tpkg test added. Uses checkconf.
	- checkconf does extra semantic tests. i.e. enable absent features.
	- tcpcount and servercount cannot be negative.
	- updated nsd.conf.5 manpage for @port syntax.
	- changed config parser: allows empty server: part (defaults).
	- made nsd.conf.sample file.
	- put option to configure for CONFIG_FILE nsd.conf location.
	  Note. Already nsdc.conf exists. Both exist now.
	- updated makefile dependencies (gcc -MM).
	- getopt optstring in nsd-checkconf updated ("v" only option).
	- Added config .o files to nsd and zonec. This compiles.
	- Added commandline option -c configfile to zonec and nsd.
	  configure defaults < configfile < commandline options in importance.

24 Feb 2006: Wouter
	- Added compute_crc in util.h and unit tests for it.
	- in cutest.tpkg the number of unit tests was hardcoded
	  in the tpkg package. Removed the dependency, cutest exit
	  value indicates if any failures happened.
	- Added crc at end of NSD-database format. Unique per db.
	  upped db version to 7 because of this.
	- Tested that crcs are big/little endian correct.
	- Added DIFF file spec
	- updated tpkg213 which compares md5 on a zonefile for new format.
	- added nsd.conf.5 manual page with a draft contents.

22 Feb 2006: nsd-team
   * Miek: Changed over to Cutest testing framework.
   * Miek: fixed typo in netio.h
   * Miek: fix syntax in rbtree.c put functions on multiple lines.
   * Miek: unit test tpkg for cutest.
   * Wouter: fixed ptr bug in rbtree unit test.

17 Feb 2006: Wouter
	- rbtree_delete is added and works. Unit tests are there too.
	- Changed tail recursion in rbtree_delete to while loop.
	- Tagged this version as NSD_3_signalsocket_solution.
	  It is the stable 2_2 branch with cleanups, portable, and
	  signalhandler solution by socket communication redesign.

15 Feb 2006: nsd-team
   * Wouter: Fixed server_child would wait for two kill signals before quit.
   * Miek: don't check for port==0 pkt, just try to send them. 
	Forward Port of 2.3.
   * Wouter: Removed unused, not substituted, @nsdxfer@ from Makefile.in.

14 Feb 2006: Wouter
	- Added unit tests for rbtree. Extensive testing of all functions.
	- Added tpkg unit test.
	- configure tests for CUnit(optional lib for unit tests). Makefile
	  cleanup so it works on non-gmake on freebsd.

13 Feb 2006: Wouter
	- Removed timespec_add(current_time) in server_main, the timeout was
	  relative, not absolute. This fixes EINVAL on the timeout on freebsd.
	- Added check in configure for compiler flags. Used for -Wextra.
	- Added check in configure for va_list definition conflict between
	  stdio and stdarg. This happens on DEC Alpha/Debian.
	- removed --enable-mmap configure option. There is no mmap support
	  in the current codebase.
	- renamed local prev to next in domain_next() in namedb.h.
	- Removed heap.h. It was not used. Heap and rbtree are mingled anyway.
	- in netio.c, in dispatch, it would store the next pointer 'in case
	  the handler removes itself'. But if the handler removes that next.
	  Then it would fail. So stored the next in struct netio.
	  This removes a potential bug. Netio_dispatch is not reentrant.
	  Reentry would need a list of iterator* in struct netio.
	- Changed process_query() to server_process_query(). It is too 
	  similar to query_process().

10 Feb 2006: nsd-team
   * Wouter: Improved configure.ac to detect pselect in sys/select.
	The check works on freebsd(yes) and fedoracore 3 and 4 (no).
	I hope it also works on Solaris.
	Also various other protoypes were implicit: chroot, strptime, ...
	These are also solved.
   * Wouter: Checked configure on sparc5(solaris). Added check for
	ctime_r in time.h (for tsig.c). This conf also works on freebsd/linux.
   * Wouter: Updated dependencies in makefile for plugin headers.
	These are included only when --enable-plugins is present.
   * Wouter: Added a send quit over socket to kill commands in server_main,
	These act when the fork children fails. If the kill fails, the
	socket command hopefully still works.
   * Wouter: Put reload code into a separate function. It communicates with
	a socket to the old parent, and sends it a quit command. This works
	and terminates the old nsd. Left in the kill as a double failsafe.
	If the reload process dies, then the parent closes the socket.
   * Wouter: Separated the signal mode from the socket-determined nsd->mode.
	Every signal function has a variable, so that multiple signals can
	arrive. Only the number of signals of the same type is lost, but not
	important for nsd. The signals are handled in turn by the run loop.
	This completes the coding to remove signal race conditions:
	- nsd uses sockets to communicate with its subprocesses(server,reload).
	- signal handler routine contains no lengthy system calls.
	- signals cannot overwrite a previous signal.
   * Wouter: fixed problem where nsd->mode and mode are different in 
	server_main. Nsd would kill the children, but then restart them again.

09 Feb 2006: nsd-team
   * Wouter: Updated dependencies in Makefile (regenerated them with gcc -MM).
   * Wouter: Used splint on the source (with settings to reduce spam.)
	And came to the following changes:
	- In util.h, make it respect HAVE_CONFIG_H and HAVE_SYSLOG_H.
	Also it now defines fallback values for #defines in syslog h.
	- Added explicit cast to (unsigned int) in snprintf in dname.c,
	dname_to_string routine.
   * Wouter: Used extra warnings during gcc compile. -Wextra -Wall 
	-pedantic -Wbad-function-cast -Wmissing-declarations 
	-Wmissing-prototypes -Wnested-externs -Wold-style-definition 
	-Wstrict-prototypes -Wdeclaration-after-statement.
	Using -Wtraditional gives too many warnings.
   * Wouter: Found a problem with pselect. sys/select.h does not by default
	provide the pselect function definition. configure script is 
	adjusted to test for this and enable _XOPEN_SOURCE=600 to get it.
	Found this using the gcc warnings.
   * Wouter: dname and rbtree test apps were in make clean target, but
	do not exist anymore. Removed from make clean target.
   * Wouter: in util log_file() the epoch time_t is passed to printf
	without an int cast. Found using extra gcc warnings.
   * Wouter: In server.c fixed some signed-unsigned comparisons
	using the extra gcc warnings.
	- in shutdown and int was used instead of size_t.
	- in server_main timeout(signed) was compared with unsigned.
	- unused variable in new handler functions.
	- in handle_child_command int i instead of size_t was used.
	- in zonec the process_rr routine was missing (void) as paramlist.
   * Wouter: Added -Wall and -Wextra when --enable-checking is enabled.
   * Miek: Ported over the big fat enable checking configure warning.
   * Wouter: fixed configure check for pselect on freebsd.

08 Feb 2006: nsd-team
   * Wouter: In server.c also sockets from unexpectedly dead childs are closed.
   * Wouter: in nsd.c and server.c cleaned out the signal handler, so that
	it only includes two switch/if statements and alters only the mode. 
	No more calls to alarm(), waitpid(), write(), log_msg().
	Instead the work is done in the runloop in server.c and sent by socket.
	Also the parent now waits for children. Parent restarts them.
   * Wouter: Fixup, the children will quit if the parent closes the command
	socket. If parent is killed, they will exit too.
   * Wouter: The server_main now listens to children command channels.
	Included timeout to check for terminated processes.
	Test says that new signal handler works, and child->parent comm.

07 Feb 2006: nsd-team 
   * Miek: configure.ac version to 3.0.0
   * Miek: looked at: buffer.{ch}, answer.{ch}, dns.{ch}
	   those files don't have any changes, except for dns.{ch} for the
	   explicit compression.
   * Miek: looked at: zlexer.lex and zparser.y; only changes there
	for the database changes.
   * Wouter: Changed buffer in write_pid from 16 bytes to 32 bytes, 
	this makes 64 bit numbers fit in the buffer.
   * Wouter: Socket connection between parent and child nsds added.
	But sighandler now in worse shape. Need to close them. Remove kills.
   * Wouter: close the parent and child command channel sockets in shutdown().
