Response Differences Between
Bind 9.3.2 and NSD 3.0.0.

Jelte Jansen <jelte@nlnetlabs.nl>
Wouter Wijngaards <wouter@nlnetlabs.nl>



Abstract

This note describes observed differences in responses between the DNS
server implementations.


Contents

0. Introduction
1. Bugs
1.1 b-rootdot - BIND does not return NXDOMAIN on 'root.'
1.2 n-clrcdbit - NSD clears CD bit in response
1.3 n-clrdobit - NSD clears DO bit in response
1.4 b-class0 - CLASS0 formerr in BIND
1.5 n-tcinquery - TC bit in query is formerr for NSD
1.6 b-soattl - BIND sets SOA TTL in authority section to 0 for SOA queries
1.7 b-classany-nxdomain - BIND gives an auth answer for class ANY nxdomain
2. Functionality Differences
2.1 d-notify - different NOTIFY errors
2.2 n-update - NSD does not implement dynamic update 
2.3 b-mailb - BIND does not implement MAILB
2.4 b-version - BIND returns servfail on version.server queries
2.5 d-additional - Different additional section on truncated answers
2.6 d-badqueryflags - Different flags on response to bad queries
2.7 d-refusedquery - BIND includes query section in REFUSED answers
2.8 d-formerrquery - BIND includes query section in FORMERR answers
2.9 b-hostname - Bind adds a NS record for hostname.bind

3. Reponse differences between NSD 2.3.6 and NSD 3.0.0
4. Reponse differences between BIND 8 and NSD 3.0.0

A. Comparison of responses to root queries.
B. Comparison of responses to NL TLD queries.


0. Introduction

The observed differences are described.  The names of the differences
refer to the statistics in Appendix A, which describe observations of
the differences in responses to real queries to a root name server and
a TLD name server.

A previous document DIFFERENCES between BIND 8.4.4 and NSD 2.0.0 exists
in the NSD 2 package.


1. Bugs

Some differences are due to bugs and/or answers not conforming to 
the Internet standards.


1.1 b-rootdot - bind does not return NXDOMAIN on 'root.'

Bind does not answer NXDOMAIN on queries for 'root.' while this domain
does not exist in class IN.

Analysis:

Bind has a pseudo domain root. somewhere.  NSD does not.


1.2 n-clrcdbit - NSD clears CD bit in response

Fixed.


1.3 n-clrdobit - NSD clears DO bit in response

NSD clears the DO bit in answers to queries with the DO bit. BIND copies the
DO bit to the answer.

Analysis:

In RFC4035 the DO bit is not specified for answers. In the examples section
of that RFC the DO bit is shown for signed dig responses, although this could 
refer to the query or the answer. NSD clears the DO bit for all answers, a 
decision based on speed: the EDNS record sent back by NSD is fixed.


1.4 b-class0 - CLASS0 formerr in BIND

For CLASS0, you can get either FORMERR(bind9) or REFUSED(nsd3).

Analysis:

Difference in interpretation of the RFCs, a CLASS value of 0 is interpreted
as a syntax error by BIND but as another valid class (that is not served)
by NSD. Resolvers are unaffected for CLASS IN.


1.5 n-tcinquery - TC bit in query is formerr for NSD

NSD returns FORMERR if tc bit is set in query.

Analysis:

Queries cannot be longer than 512 octets, since the DNS header is 20 octets
and the query DNS name can be 255 octets maximum. Thus TC (TrunCation) cannot
happen. Only one question per query packet is answered by NSD, this is a
design decision.

Some update, ixfr request, notify, gss-tsig TKEY sequence queries could 
theoretically carry longer data in the query from the client. In practice
this does not happen, as 255 octet uncompressed names are not used.
If this were to happen, the client could attempt a TCP connection
immediately instead of sending a TC bit, or use EDNS0 to send longer packets.

In this NSD is more strict in validation than BIND.


1.6 b-soattl - Bind sets SOA TTL in authority section to 0 for SOA queries

This happens when asking for the SOA for a domain that is not served.

Query:
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 0
;; flags: rd ; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; foo.bar.     IN      SOA


Answer from Bind 9.3.2:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 6097
;; flags: qr aa rd ; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;; foo.bar.     IN      SOA

;; ANSWER SECTION:

;; AUTHORITY SECTION:
.       0       IN      SOA     A.ROOT-SERVERS.NET. NSTLD.VERISIGN-GRS.COM. 2006072801 1800 900 604800 86400

;; ADDITIONAL SECTION:

;; Query time: 10 msec
;; SERVER: 127.0.0.1
;; WHEN: Wed Aug 23 13:52:36 2006
;; MSG SIZE  rcvd: 100


Answer from NSD 3:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 26095
;; flags: qr aa rd ; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;; foo.bar.     IN      SOA

;; ANSWER SECTION:

;; AUTHORITY SECTION:
.       86400   IN      SOA     a.root-servers.net. nstld.verisign-grs.com. 2006072801 1800 900 604800 86400

;; ADDITIONAL SECTION:

;; Query time: 60 msec
;; SERVER: 127.0.0.1
;; WHEN: Wed Aug 23 13:53:30 2006
;; MSG SIZE  rcvd: 100

Analysis:

BIND conforms to internet-draft draft-andrews-dnsext-soa-discovery which has 
not (yet) been published as RFC. NSD conforms to the RFCs.


1.7 b-classany-nxdomain - BIND gives an auth answer for class ANY nxdomain

A difference in behaviour for CLASS=ANY queries. For existing domains both
BIND and NSD reply with AA bit cleared. For not existing domains (nxdomain)
NSD replies with AA bit cleared. BIND replies with AA bit on and includes a
SOA (CLASS=IN) for the zone, as for an authoritative nxdomain.

Query:

;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 13328
;; flags: ; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; nslabs.ruO.  ANY     MX

Answer from BIND 9.3.2:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 13328
;; flags: qr aa ; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;; nslabs.ruo.  ANY     MX

;; ANSWER SECTION:

;; AUTHORITY SECTION:
.       86400   IN      SOA     a.root-servers.net. nstld.verisign-grs.com. 2006072801 1800 900 604800 86400

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; WHEN: Wed Aug 23 13:58:51 2006
;; MSG SIZE  rcvd: 103

Answer from NSD 3:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 13328
;; flags: qr ; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; nslabs.ruo.  ANY     MX

;; ANSWER SECTION:

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; WHEN: Wed Aug 23 13:58:51 2006
;; MSG SIZE  rcvd: 28

Analysis:

Bug in bind where it answers authoritatively for CLASS ANY nxdomain queries.


2. Functionality Differences

The next group of differences are due to the fact that NSD does not
implement some functionality that is requested.  This is a design
choice and should not cause resolver problems at all.


2.1 d-notify - different NOTIFY errors

for NOTIFY, you can get either NOTAUTH/NOERROR(bind9) or
NXDOMAIN/NOTAUTH(nsd3):  18 (0.00%)

Analysis:

Look at queries.


2.2 n-update - NSD does not implement dynamic update 

For UPDATE, you can get either REFUSED/NXRRSET(bind9) or NOTIMPL(nsd3).

Analysis:

NSD does not implement dynamic update. 


2.3 b-mailb - BIND does not implement MAILB

For MAILB, you can get either NOTIMPL(bind9) or NOERROR/NXDOMAIN(nsd3).

Analysis:

BIND does not implement the MAILB type in queries. NSD treats it as a 
data type. MAILB is obsoleted by RFCs, the MX type is used to 
transfer mail information now.


2.4 b-version - BIND returns servfail on version.server queries.

NSD returns version.server query, BIND returns servfail.

Analysis:

Both NSD and BIND return version.bind queries of the chaos class.
BIND does not return version.server queries. This is a design decision
on the part of NSD to return version.server queries with the same answer.


2.5 d-additional - Different additional section on truncated answers

NSD and BIND return different additional sections on truncated answers
to queries from the root. 

Analysis:

Not all the A and AAAA data fits into the additional section of the answer.
BIND includes different names than NSD does, and BIND is observed to sometimes
include one more AAAA record, one less A record in the additional section.
Resolvers should be unaffected.


2.6 d-badqueryflags - Different flags on response to bad queries

On reply to a query that cannot be parsed, BIND and NSD give different flags.

Analysis:

The query is a form error, flags on the return are not mandated by RFCs, and
not needed for the resolver.


2.7 d-refusedquery - BIND includes query section in REFUSED answers

BIND includes the query sent for REFUSED answers. NSD replies with only
the DNS header section.

Analysis:

The resolver must inspect the query ID. The error code provides sufficient
information. Sending the header makes NSD replies smaller and thus more 
resilient to DoS attacks.


2.8 d-formerrquery - BIND includes query section in FORMERR answers

BIND includes the query sent for FORMERR answers. NSD replies with only
the DNS header section.

Analysis:

The resolver must inspect the query ID. The error code provides sufficient
information. Sending the header makes NSD replies smaller and thus more 
resilient to DoS attacks.


2.9 b-hostname - Bind adds a NS record for hostname.bind

BIND includes an additional RR in the authority section of the reply:
hostname.bind. 0 CH NS hostname.bind.

Analysis:

The RR seems useless. NSD does not include it.


3. Reponse differences between NSD 2.3.6 and NSD 3.0.0


4. Reponse differences between BIND 8 and NSD 3.0.0


A. Comparison of responses to root queries.

Comparison between NSD 3.0.0 and BIND 9.3.2.

d-additional:                                    22336  (56.14%)
n-clrdobit:                                      11912  (29.94%)
b-soattl:                                        5309   (13.34%)
d-badqueryflags:                                 11     (0.03%)
n-update:                                        101    (0.25%)
d-formerrquery:                                  60     (0.15%)
d-hostname:                                      46     (0.12%)
d-refusedquery:                                  3      (0.01%)
b-class0:                                        10     (0.03%)
Total number of differences: 39788 (100%)
Number of packets exactly the same: 60212
Total number of packets inspected: 100000


B. Comparison of responses to NL TLD queries.
