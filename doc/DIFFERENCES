Response Differences Between
Bind 9.3.2 and NSD 3.0.0.

Jelte Jansen <jelte@nlnetlabs.nl>
Wouter Wijngaards <wouter@nlnetlabs.nl>



Abstract

This note describes observed differences in responses between the DNS
server implementations.


Contents

0. Introduction
1. Bugs
.. 1.1 b-rootdot - BIND does not return NXDOMAIN on 'root.'
.. 1.2 n-clrdobit - NSD clears DO bit in response
.. 1.3 b-class0 - CLASS0 formerr in BIND
.. 1.4 n-tcinquery - TC bit in query is formerr for NSD
.. 1.5 b-soattl - BIND sets SOA TTL in authority section to 0 for SOA queries
.. 1.6 b-classany-nxdomain - BIND gives an auth answer for class ANY nxdomain
.. 1.7 d-badquerynoanswer - BIND does not answer some malformed queries
2. Functionality Differences
.. 2.1 d-notify - different NOTIFY errors
.. 2.2 n-update - NSD does not implement dynamic update 
.. 2.3 b-mailb - BIND does not implement MAILB
.. 2.4 b-version - BIND returns servfail on version.server queries
.. 2.5 d-additional - Different additional section on truncated answers
.. 2.6 d-refusedquery - BIND includes query section in REFUSED answers
.. 2.7 d-formerrquery - BIND includes query section in FORMERR answers
.. 2.8 d-hostname - BIND adds a NS record for hostname.bind
.. 2.9 n-ixfr-notimpl - NSD does not implement IXFR
.. 2.10 d-badqueryflags - BIND includes query section in FORMERR answers
.. 2.11 d-unknown-opcode - NSD returns NOTIMPL for unknown opcode
.. 2.12 b-upwards-ref - BIND returns root delegation
.. 2.13 b-noglue-nsquery - BIND returns no glue for NS queries.
3. Reponse differences between NSD 2.3.6 and NSD 3.0.0
.. 3.1. Version number: version.bind and version.server.
.. 3.2. n-notify: notify not implemented in NSD 2
.. 3.3. n-ixfr: IXFR error FORMERR in NSD 2
.. 3.4. Comparison of responses in root trace.
.. 3.5. Comparison of responses in NL TLD trace.
4. Reponse differences between BIND 8 and NSD 3.0.0
.. 4.1 b-ttlminup BIND 8 uses minimum TTL from SOA also if bigger
A. Comparison of responses to root queries.
B. Comparison of responses to NL TLD queries.


0. Introduction

The observed differences are described.  The names of the differences
refer to the statistics in Appendix A, which describe observations of
the differences in responses to real queries to a root name server and
a TLD name server.

A previous document DIFFERENCES between BIND 8.4.4 and NSD 2.0.0 exists
in the NSD 2 package.


1. Bugs

Some differences are due to bugs and/or answers not conforming to 
the Internet standards.


1.1 b-rootdot - BIND does not return NXDOMAIN on 'root.'

Bind does not answer NXDOMAIN on queries for 'root.' while this domain
does not exist in class IN.

Analysis:

Bind has a pseudo domain root. somewhere.  NSD does not.


1.2 n-clrdobit - NSD clears DO bit in response

NSD clears the DO bit in answers to queries with the DO bit. BIND copies the
DO bit to the answer.

Analysis:

In RFC4035 the DO bit is not specified for answers. In the examples section
of that RFC the DO bit is shown for signed dig responses, although this could 
refer to the query or the answer. NSD clears the DO bit for all answers, a 
decision based on speed: the EDNS record sent back by NSD is fixed.


1.3 b-class0 - CLASS0 formerr in BIND

For CLASS0, you can get either FORMERR(bind9) or REFUSED(nsd3).

Analysis:

Difference in interpretation of the RFCs, a CLASS value of 0 is interpreted
as a syntax error by BIND but as another valid class (that is not served)
by NSD. Resolvers are unaffected for CLASS IN.


1.4 n-tcinquery - TC bit in query is formerr for NSD

NSD returns FORMERR if tc bit is set in query.

Analysis:

Queries cannot be longer than 512 octets, since the DNS header short:w
and the query DNS name can be 255 octets maximum. Thus TC (TrunCation) cannot
happen. Only one question per query packet is answered by NSD, this is a
design decision.

Some update, ixfr request, notify, gss-tsig TKEY sequence queries could 
theoretically carry longer data in the query from the client. In practice
this does not happen, as 255 octet uncompressed names are not used.
If this were to happen, the client could attempt a TCP connection
immediately instead of sending a TC bit, or use EDNS0 to send longer packets.

In this NSD is more strict in validation than BIND.


1.5 b-soattl - BIND sets SOA TTL in authority section to 0 for SOA queries

This happens when asking for the SOA for a domain that is not served.

Query:
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 0
;; flags: rd ; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; foo.bar.     IN      SOA


Answer from Bind 9.3.2:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 6097
;; flags: qr aa rd ; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;; foo.bar.     IN      SOA

;; ANSWER SECTION:

;; AUTHORITY SECTION:
.       0       IN      SOA     A.ROOT-SERVERS.NET. NSTLD.VERISIGN-GRS.COM. 2006072801 1800 900 604800 86400

;; ADDITIONAL SECTION:

;; Query time: 10 msec
;; SERVER: 127.0.0.1
;; WHEN: Wed Aug 23 13:52:36 2006
;; MSG SIZE  rcvd: 100


Answer from NSD 3:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 26095
;; flags: qr aa rd ; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;; foo.bar.     IN      SOA

;; ANSWER SECTION:

;; AUTHORITY SECTION:
.       86400   IN      SOA     a.root-servers.net. nstld.verisign-grs.com. 2006072801 1800 900 604800 86400

;; ADDITIONAL SECTION:

;; Query time: 60 msec
;; SERVER: 127.0.0.1
;; WHEN: Wed Aug 23 13:53:30 2006
;; MSG SIZE  rcvd: 100

Analysis:

BIND conforms to internet-draft draft-andrews-dnsext-soa-discovery which has 
not (yet) been published as RFC. NSD conforms to the RFCs.


1.6 b-classany-nxdomain - BIND gives an auth answer for class ANY nxdomain

A difference in behaviour for CLASS=ANY queries. For existing domains both
BIND and NSD reply with AA bit cleared. For not existing domains (nxdomain)
NSD replies with AA bit cleared. BIND replies with AA bit on and includes a
SOA (CLASS=IN) for the zone, as for an authoritative nxdomain.

Query:

;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 13328
;; flags: ; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; nslabs.ruO.  ANY     MX

Answer from BIND 9.3.2:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 13328
;; flags: qr aa ; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;; nslabs.ruo.  ANY     MX

;; ANSWER SECTION:

;; AUTHORITY SECTION:
.       86400   IN      SOA     a.root-servers.net. nstld.verisign-grs.com. 2006072801 1800 900 604800 86400

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; WHEN: Wed Aug 23 13:58:51 2006
;; MSG SIZE  rcvd: 103

Answer from NSD 3:

;; ->>HEADER<<- opcode: QUERY, rcode: NXDOMAIN, id: 13328
;; flags: qr ; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; nslabs.ruo.  ANY     MX

;; ANSWER SECTION:

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; WHEN: Wed Aug 23 13:58:51 2006
;; MSG SIZE  rcvd: 28

Analysis:

Bug in bind where it answers authoritatively for CLASS ANY nxdomain queries.


1.7 d-badquerynoanswer - BIND does not answer some malformed queries

For some queries BIND does not generate an answer. NSD always generates
an answer. All these queries are malformed in some way.

Analysis:

NSD manages to answer the malformed query. Note that NSD does not answer 
queries that are too short, or that have the QR bit set.


2. Functionality Differences

The next group of differences are due to the fact that NSD does not
implement some functionality that is requested.  This is a design
choice and should not cause resolver problems at all.


2.1 d-notify - different NOTIFY errors

BIND and NSD give different errors for notify queries. The servers are started 
without any configuration for access control on notify. For notify messages 
aimed at a zone that is served, BIND 9.3.2 returns a NOERROR answer, and 
NSD 3 returns NOTAUTH. For notify messages on a zone that is not served 
(in-addr.arpa.) BIND 9.3.2 returns NOTAUTH and NSD 3 returns NXDOMAIN.

Analysis:

Default configuration differs between the two packages. NSD is more strict.
Error codes are different, the tools that send notifies are not affected.


2.2 n-update - NSD does not implement dynamic update 

For UPDATE, you can get either REFUSED/NXRRSET/other RCODE from bind9 or 
NOTIMPL frmo nsd3.

Analysis:

NSD does not implement dynamic update. 


2.3 b-mailb - BIND does not implement MAILB

For MAILB, you can get either NOTIMPL(bind9) or NOERROR/NXDOMAIN(nsd3).

Analysis:

BIND does not implement the MAILB type in queries. NSD treats it as a 
data type. MAILB is obsoleted by RFCs, the MX type is used to 
transfer mail information now.


2.4 b-version - BIND returns servfail on version.server queries.

NSD returns version.server query, BIND returns servfail.

Analysis:

Both NSD and BIND return version.bind queries of the chaos class.
BIND does not return version.server queries. This is a design decision
on the part of NSD to return version.server queries with the same answer.


2.5 d-additional - Different additional section on truncated answers

NSD and BIND return different additional sections on truncated answers
to queries from the root. These answers are 480+ bytes long.

Analysis:

Not all the A and AAAA data fits into the additional section of the answer.
BIND includes different names than NSD does, and BIND is observed to sometimes
include one more AAAA record, less A records in the additional section.
Resolvers should be unaffected.


2.6 d-refusedquery - BIND includes query section in REFUSED answers

BIND includes the query sent for REFUSED answers. NSD replies with only
the DNS header section.

Analysis:

The resolver must inspect the query ID. The error code provides sufficient
information. Sending the header makes NSD replies smaller and thus more 
resilient to DoS attacks.


2.7 d-formerrquery - BIND includes query section in FORMERR answers

BIND includes the query sent for FORMERR answers. NSD replies with only
the DNS header section. For some queries, NSD includes an EDNS record in 
the reply if there was a recognizable EDNS record in the query.

Analysis:

The resolver must inspect the query ID. The error code provides sufficient
information. Sending the header makes NSD replies smaller and thus more 
resilient to DoS attacks.


2.8 d-hostname - BIND adds a NS record for hostname.bind

BIND includes an additional RR in the authority section of the reply:
hostname.bind. 0 CH NS hostname.bind.

Analysis:

The RR seems useless. NSD does not include it.


2.9 n-ixfr-notimpl - NSD does not implement IXFR

To queries for IXFR bind responds with a valid answer (the latest SOA)
and NSD responds with NOTIMPL error.

Analysis:

NSD 3.0.0 does not implement IXFR. It returns NOTIMPL by design.


2.10 d-badqueryflags - BIND includes query section in FORMERR answers

Bind includes the query section in reply to unparseable queries. NSD does not.

Analysis:

Same as d-formerrquery, but the implementation of the comparison software could
not parse the query either, thus a separate label.


2.11 d-unknown-opcode - NSD returns NOTIMPL for unknown opcode

For queries that are bad packets, with malformed RRs, with an unknown opcode,
BIND returns a FORMERR, but NSD gives up after checking the opcode and
returns NOTIMPL.  NSD copies the flags from the query, and turns on the 
QR (query response) bit, BIND zeroes some of the flags.

Analysis:

NOTIMPL is appropriate since NSD does not implement whatever functionality
is being looked for. 


2.12 b-upwards-ref - BIND returns root delegation

For queries to a domain that is not served, which can only have arrived at
this server due to a lame delegation, Bind returns a root delegation. NSD
returns SERVFAIL.

Analysis:

By design, NSD does not know the root-servers.  NSD is unable to reply as
the zone is not configured, hence the SERVFAIL.


2.13 b-noglue-nsquery - BIND returns no glue for NS queries

For queries for the NS records of the zone, BIND does not include glue
for the NS records. NSD includes glue for the NS servers that lie within
the zone.

Analysis:

The glue saves a followup query.


3. Reponse differences between NSD 2.3.6 and NSD 3.0.0

The differences between NSD 2.3.6 and NSD 3.0.0 are listed below. All are due
to version number changes and new features in NSD 3.


3.1. Version number: version.bind and version.server.

To queries for version.bind and version.server the different implementations
return a different version number, as they should.

Analysis:

Expected. Correct version numbers are returned.


3.2. n-notify: notify not implemented in NSD 2

Notifications are handled differently. NSD 2 returns NOTIMPL error code,
while NSD 3 returns NOTAUTH or NXDOMAIN error codes.

Analysis:

Default config denies all notify queries for NSD 3. These answers are correct
for non-existing and not authorized domains.


3.3. n-ixfr: IXFR error FORMERR in NSD 2

To IXFR query questions different error codes are given. The NSD 2
gives FORMERR (due to the RR in the authority section). NSD 3 returns
NOTIMPL. 

Analysis:

Neither version of NSD implements IXFR. It is more appropriate to
return the NOTIMPL error code in that case. Bugfix in NSD.


3.4. Comparison of responses in root trace.

Differences between NSD 2.3.6 and NSD 3.0.0 for a root trace.
Note that apart from the 26 packets that are different, all responses are
binary the same on the wire between the two versions of NSD.
-difference-				     -packets-  -%diff-
n-notify:                                        19     (73.08%)
n-ixfr:                                          3      (11.54%)
version.bind:                                    3      (11.54%)
version.server:                                  1      (3.85%)
Total number of differences:                     26     (100%)
Number of packets the same after normalization: 2244590
Number of packets exactly the same on the wire: 2244590
Total number of packets inspected:              2244616


3.5. Comparison of responses in NL TLD trace.

Differences between NSD 2.3.6 and NSD 3.0.0 for a nl. trace.
Note that apart from the 311 packets that are different, all responses are
binary the same on the wire between the two versions of NSD.

-difference-				     -packets-  -%diff-
n-notify:                                        289    (92.93%)
version.bind:                                    22     (7.07%)
Total number of differences: 			311 	(100%)
Number of packets the same after normalization: 99689
Number of packets exactly the same on the wire: 99689
Total number of packets inspected: 		100000


4. Reponse differences between BIND 8 and NSD 3.0.0

4.1 b-ttlminup BIND 8 uses minimum TTL from SOA also if bigger

For NXDOMAIN queries in root-servers.net BIND 8 uses the minimum TTL from
the SOA as the TTL of the included SOA RR. However, this minimum TTL is 
larger than the original TTL of the SOA, both NSD 2.3.6, NSD 3 and BIND 9
use the smaller of those two values as the TTL of the included SOA.

Analysis:

Bug in BIND 8 solved in BIND 9.


A. Comparison of responses to root queries.

Comparison between NSD 3.0.0 and BIND 9.3.2 for a root trace.

-difference-				       -packets- -%diff-
d-additional:                                    455607 (59.19%)
n-clrdobit:                                      208389 (27.07%)
b-soattl:                                        101707 (13.21%)
n-update:                                        1858   (0.24%)
d-hostname:                                      1032   (0.13%)
d-formerrquery:                                  773    (0.10%)
b-class0:                                        264    (0.03%)
d-refusedquery:                                  79     (0.01%)
d-notify:                                        18     (0.00%)
b-mailb:                                         7      (0.00%)
n-tcinquery:                                     6      (0.00%)
b-classany-nxdomain:                             5      (0.00%)
d-badqueryflags:                                 4      (0.00%)
n-ixfr-notimpl:                                  3      (0.00%)
b-version:                                       1      (0.00%)
Total number of differences:                    769753  (100%)
Number of packets the same after normalization: 1474863
Number of packets exactly the same on the wire: 59161
Total number of packets inspected:              2244616


B. Comparison of responses to NL TLD queries.

Comparison between NSD 3.0.0 and BIND 9.3.2, for a trace for .nl.

-difference-				       -packets- -%diff-
d-unknown-opcode:                                3412   (35.50%)
d-badquerynoanswer:                              1817   (18.91%)
n-clrdobit:                                      1495   (15.56%)
b-soattl:                                        1120   (11.65%)
n-update:                                        932    (9.70%)
d-hostname:                                      553    (5.75%)
d-notify:                                        195    (2.03%)
b-upwards-ref:                                   78     (0.81%)
b-noglue-nsquery:                                8      (0.08%)
d-formerrquery:                                  1      (0.01%)
Total number of differences: 			9611	(100%)
Number of packets the same after normalization: 90389
Number of packets exactly the same on the wire: 52336
Total number of packets inspected: 		100000

