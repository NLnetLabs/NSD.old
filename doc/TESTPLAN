TEST PLAN for NSD.

By W.C.A. Wijngaards, July 2006, NLnetLabs.


1. Introduction
---------------
NSD 3 contains far more features than a typical point release. These
features need to be tested and checked to make sure they work well.
This document describes a plan to test all the features that have
been added to NSD.

Regression testing is also very important. The old features must
remain working. We have a set of tpkg packages to help with it.
And also root-trace speed tests to regression test NSD.

The feature tests are to be automated, using tpkg packages where
possible.

2. Minor Features
-----------------
Some minor features for the test:

2.1. DNAME
----------
DNAME support - there are already extensive DNAME tests.
(closed).

2.2. NSEC3
----------
NSEC3 support 
	- use the perl automated nsec3 test
		- port to tpkg perhaps.

Note NSEC3 hash length byte to be implemented, test against others.
Test interoperability of that. A simple zone transfer with Bind.
(experimental, no need to test any more).

2.3. NSID
---------
Would make a nice nsid.tpkg package.

NSID support - run NSD with different NSIDs and queries.
	a- test NSID with zero length, query with NSID.
	b- very long length, query with NSID
	c- 012345678 and query for different things.
		1- query OK things.
		- query error 
			2- nxdomain, 
			3- loop, 
			4- nodata.
		5- query error (bad queries, wrong zone)
			- is NSID present.
	d- NSID and TSIG.
		1- query has OK TSIG
		2- query has BAD TSIG
		3- query for nxdomain
		4- bad query, wrong zone
	e- configure NSID from config file?
		- is this possible

	f- test if NSID in NOTIFY responses. (should there?)
		ldns-notify and parse result packet for nsid.
	g- test if NSID in AXFR responses. (should there?)
		drill axfr <zone> and see if nsid in result packets.
(experimental, so low priority).
(need a way to send NSID enabled queries - no test).

3. Transfers
------------
For the transfers the test are to be done using
- NSD as a master(AXFR) in 3.1, or a ldns-ixfr miniserver(IXFR)
  as a master in 3.2 that serves pre-made ixfr answers.

The zone transfer tests can be put in one tpkg by using servers
at different ports. The allow- lines are then for localhost, all 
ports (since the sending process uses ephemeral ports, all must
be allowed). The request- lines contain the correct port numbers
to send to. 

3.1. AXFR
---------
3.1.1. AXFR features
--------------------
Setup is a secondary zone which requests to a master.
the master zone is updated. Then, the secondary should be 
informed with the notify: statements.
And test if secondary got the same zone as master.
By doing axfr from both servers and check if the same, and serial nr. 

Tests 3.1.1 can be one tpkg.

(with serial numbers for SOA, to perform serial rollover).
- secondary starts with a zone without content (soa=1)
  so the zone is only mentioned in the config, the zonefile is empty/nonexist
  on the slave. Master has a soa and three text records.
- axfr an empty zone - only the SOA 	(soa=2)
- axfr a zone with only little data. 	(soa=3)
  some NS, MX, A, AAAA records.
[NOTE: apparantly, due to the linked list mgt in domains (of rrset*)
 the ordering of rrtypes for a domain is reversed after a zone transfer
 for NSD, i.e. for query type=any. Ordering within an rrset is preserved.]
- old zone unsigned, new zone signed. 	(soa=4)
  sign with two KSKs and one ZSK. And a prepublished ZSK in the zone.
- old zone signed, new zone unsigned. 	(soa=5)
  different zone contents, some names are still there, 
  unchanged, some names are there RRs changed, some names
  there different RRtypes, and some names removed, some names added.
- new zone with nsec3.			(soa=6)
- new parameters for nsec3.		(soa=7)
- new zone no longer uses nsec3.	(soa=8)
- axfr an empty zone (only the SOA)	(soa=9 + a lot for serial wraparound)
- axfr wraparound zone, couple txts.	(soa=2)
These can be done in order.

3.1.2. Huge xfr - see test tpkg for this.
It works already.

3.2. IXFR 
---------
3.2.1. IXFR Features
--------------------
Setup is a secondary with ldns-mini-ixfr server as a master.
The mini ixfr server responds with canned replies to a IXFR query.

- secondary loaded with only the soa = 1. notified with 10.
  ixfr server responds with soa=1. (i.e. no update available).
- same, ixfr server responds with soa=2, and TC (udp).
  on tcp connection, it responds with a simple difference package.
  SOA2 SOA1 SOA1 SOA2 newTXTA newTXTB SOA2
  adds a couple records.
- to soa is 3, and this one removes the TXT records,
  makes a new TXTB record and a TXTC record.  test that TXTA domain does not exist NXDOMAIN.
  test that TXTB is updated.
  test that TXTC exists.
- from 3 to 5, with 4 in between.
  make a ixfr packet that is  3 .. 4 and 4 .. 5 concatenated without
  compression, so it means more work for processing.
  So, in the ixfr packet TXTB is removed from 3, added in 4, removed from 4,
  added in 5.
- from 5 to 7, but this time the redundant work is removed from ixfr packet.
- 7 to 8, have one domain name where two RR types exist, A and DNAME.
  remove one RR type in IXFR then make sure the other type still exists.
- 8 to 9, have a name with many different A records. Remove one A record
  from it. Add another A record to it. Test if the rest is there.

3.2.2. a huge ixfr.
-------------------
create test for it. Should be several MBs worth or data removed, MBs of
data that stays the same, and MBs that are added.
To make sure that the code can handle multiple packet IXFRs, and the
state memory between IXFR packets.

3.2.3. Test remove domain
-------------------------
- is_existing = 0 used to remove a domain. Check and test carefully.
        - test delete middle zone
	- test delete/add a domain and NXdomain/exist replies.
	- test delet domain and wildcard replies.

3.3. Timouts
------------
Get zone to expire. Check it does not answer.
	Start only a secondary server, no master. Set expire timeout short.
Provide an update. Check it does answer again.
	Startup the master server after a while. Transfer should happen
	within the retry interval.

Get zone to expire. Check it does not answer.
Keep master down so that the zone stays expired.
Provide no update, but master replies 'zone still at version x',
by axfr or ixfr. Check it answers again.
-- same but the master that goes up is the ldns-ixfr canned 
   response that will, this time say that the serial is OK.

3.4. TSIG zone transfers
------------------------
Already TSIG tpkg tests, with transfers TSIG protected, so that is ok.
TSIG notifies - test it, create test for it.
	- notify accepted, nsd->nsd notify
	  by starting master and slave server with tsig keys
	  for a zone, update zone at master.
	- notify refused. nsd->nsd notify
	  same but use different secret at one server.

4. IPC
--------

4.1. deadlocks
--------------
Have 100.000 zones, all with short SOA timeouts, expire=1 sec. refresh=10.
Expire very quickly. This gives many messages from xfrd to server.
Send notifies to the server in a loop from a shell script. Lots of
messages the other way around.
Provide a master server that will serve all the zones (and say they are ok).

then proceed to send queries for the zones to the server and see if you 
get answers. Wait for an hour and try again.

Perhaps do also with 1000 child servers for the NSD. see if it can keep
up and the result if it cannot keep up sending to child servers.
Since it has to send for each zone to each child a message, this will
take more resources.

Due to the length and size, more an incidental test, but can be tpkg-ed.

4.2. IPC FORKS
--------------
Infinite loop of reloads on a server. Has 10 child servers. wait.
See if it runs out of sockets, file descriptors, etc.
incidental test.

5. Random mess test
-------------------
Setup N servers. In  master->intermed->slave,
with multiple master(2), intermed(3) and slave(2) servers.
TSIGs for everyone.
Perhaps also include never respond entries (fake address) in acls.

- Load random SOA + random data in servers.
  Backup the setup so it is repeatable.
  Let them work out what version to run.
- Provide updated zone for a master.
  See what happens.
- Send notifies to the slave servers.
- Send notifies to the intermed servers.
- Send notifies to the master servers.
- Kill some server. Start it again.
- Kill some server & delete some file (ixfr.db or xfrd.status).
- run nsdc patch on a server.

- pretend an intemediary was offline for a long time
  with old zone files and old ixfr.db and xfrd.state(!!) files.
  and see what happens :-)
  It should refresh/expire and so based on timers in xfrd.state.

6. Portability test
-------------------
Port NSD to as many platforms as possible
- local: sparc5(ok), alpha(ok), amd64/OpenBsd(jelte thuis), 
	open=FreeBSD(ok), linuxes(ok), MacOsX(ok), Sunos4(ok).
- sf compilefarm for more.
- minix3 if we can get it working (the minix3 setup fails somehow).

- would be good to have a test set of tpkg (and tools required) to
  run after a port-test. A very portable set of tpkgs.

7. CODE REVIEW
--------------
Code has already had 1x review by Wouter, some review by Miek.
More review (again), Jelte, Wouter. 
- Do some spots of interest.
- perhaps a full review as well.

8. todo-tests ideas
-------------------
These would be nice as tpkgs, but perhaps manual tests are needed.

8.1. test combinations of configure options and shells
------------------------------------------------------
"
run tests with different shells, aka ==-bug
run tests with different configure options and combinations
    of them.
implement this in a xen-like environment so that different OSs can
be checked.
run this daily or only when subversion changes
for each test, run our "test-suite"
"

8.2. patch file remove
----------------------
rm patch file, check xfrd's behavoir. Refetches zones

8.3. 64 bit
-----------
GB 64 bit file size transfers. On alpha so nastiest
alignment on 64bit machine. Do transfer of > 4 Gb zone.
Needs lots of memory(swap space) and disk space.

8.4. Valgrind
-------------
run with valgrind - on two nsds.
then do the nsd-nsd, and notify the master to get axfr
to happen test, with tsig as well enabled.

8.5. Chroot
-----------
test chroot and the new files/directories.
(And the file/dir not in chroot problem, and if all is OK that it works).

8.6. nsdc
---------
In temporary test setup above, test nsdc tool.

Make sure that if nsdc patch breaks a zone transfer in progress it is
reattempted later on.
